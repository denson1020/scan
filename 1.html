<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Inventory</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #007AFF;
            --success-color: #34C759;
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #1C1C1E;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
        }

        /* ヘッダー */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            text-align: center;
            border-bottom: 1px solid #c6c6c8;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* メインコンテナ */
        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* カメラエリア */
        #camera-wrapper {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #reader { width: 100%; height: 100%; }
        
        /* カメラ停止中の表示 */
        .camera-placeholder {
            color: #fff;
            text-align: center;
            display: none;
        }
        .camera-placeholder i { font-size: 3rem; margin-bottom: 10px; opacity: 0.7; }

        /* スキャン結果カード */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .label {
            font-size: 0.8rem;
            color: #8E8E93;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .value {
            font-size: 1.5rem;
            font-weight: 700;
            word-break: break-all;
            min-height: 1.8rem;
        }
        .placeholder-text { color: #C7C7CC; }

        /* 数量入力エリア */
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        .qty-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #E5E5EA;
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .qty-btn:active { background: #D1D1D6; }
        .qty-input {
            width: 80px;
            text-align: center;
            font-size: 1.8rem;
            border: none;
            font-weight: bold;
            background: transparent;
        }

        /* アクションボタン */
        .btn-main {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
        }
        .btn-primary:active { opacity: 0.8; }
        .btn-primary:disabled { background-color: #A0A0A5; cursor: not-allowed; box-shadow: none; }

        .btn-toggle {
            background-color: #E5E5EA;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        /* トースト通知 */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        #toast.success { background-color: var(--success-color); }
        #toast.error { background-color: #FF3B30; }

        /* ロード中のスピナー */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<header>
    <span>棚卸アプリ</span>
    <i class="fa-solid fa-boxes-stacked" style="color: var(--primary-color);"></i>
</header>

<div class="container">

    <div id="camera-wrapper">
        <div id="reader"></div>
        <div class="camera-placeholder" id="camera-placeholder">
            <i class="fa-solid fa-camera-slash"></i>
            <p>カメラ停止中</p>
        </div>
    </div>

    <button class="btn-main btn-toggle" id="toggle-camera-btn" onclick="toggleCamera()">
        <i class="fa-solid fa-camera"></i> カメラを起動
    </button>

    <div class="card">
        <div class="label">商品コード (JAN/QR)</div>
        <div class="value placeholder-text" id="code-display">未スキャン</div>

        <hr style="border: 0; border-top: 1px solid #E5E5EA; margin: 15px 0;">

        <div class="label">数量</div>
        <div class="quantity-control">
            <button class="qty-btn" onclick="updateQty(-1)"><i class="fa-solid fa-minus"></i></button>
            <input type="number" class="qty-input" id="qty-input" value="1" readonly>
            <button class="qty-btn" onclick="updateQty(1)"><i class="fa-solid fa-plus"></i></button>
        </div>
    </div>

    <button class="btn-main btn-primary" id="submit-btn" onclick="submitData()">
        <span class="spinner" id="spinner"></span>
        <span id="btn-text">登録する</span>
    </button>

</div>

<div id="toast">Message</div>

<script>
    // ==========================================
    // 設定エリア
    // ==========================================
    // ↓ここにPower AutomateのURLを貼り付けてください
    const POWER_AUTOMATE_URL = "YOUR_POWER_AUTOMATE_URL_HERE"; 
    // ==========================================

    let html5QrCode = null;
    let isCameraRunning = false;
    let currentCode = null;

    // 音声コンテキストの準備（ビープ音用）
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playBeep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.value = 1000; // 1000Hz
        gainNode.gain.value = 0.1; // 音量
        oscillator.start();
        setTimeout(() => { oscillator.stop(); }, 100); // 0.1秒鳴らす
        
        // バイブレーション（Android等対応機種のみ）
        if (navigator.vibrate) navigator.vibrate(200);
    }

    // 数量の増減
    function updateQty(change) {
        const input = document.getElementById('qty-input');
        let val = parseInt(input.value) + change;
        if(val < 1) val = 1;
        input.value = val;
    }

    // カメラの起動・停止切り替え
    async function toggleCamera() {
        const btn = document.getElementById('toggle-camera-btn');
        const placeholder = document.getElementById('camera-placeholder');

        if (isCameraRunning) {
            // 停止処理
            await html5QrCode.stop();
            html5QrCode = null;
            isCameraRunning = false;
            btn.innerHTML = '<i class="fa-solid fa-camera"></i> カメラを起動';
            placeholder.style.display = 'block';
        } else {
            // 起動処理
            placeholder.style.display = 'none';
            btn.innerHTML = '<i class="fa-solid fa-stop"></i> カメラを停止';
            startScanner();
        }
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0 
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            console.error(err);
            showToast("カメラの起動に失敗しました", "error");
        });
        isCameraRunning = true;
    }

    // スキャン成功時の処理
    function onScanSuccess(decodedText, decodedResult) {
        if (currentCode === decodedText) return; // 重複読み取り防止（簡易）

        playBeep();
        currentCode = decodedText;
        
        const display = document.getElementById('code-display');
        display.innerText = decodedText;
        display.classList.remove('placeholder-text');
        
        // 視覚的なフィードバック（一瞬枠を光らせるなど）
        document.getElementById('camera-wrapper').style.border = "4px solid #34C759";
        setTimeout(() => {
            document.getElementById('camera-wrapper').style.border = "none";
        }, 300);

        // 必要であればここで自動的にカメラを一時停止するなど
        // html5QrCode.pause(); 
    }

    // データ送信処理
    function submitData() {
        const qty = parseInt(document.getElementById('qty-input').value);
        const btn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btn-text');

        if (!currentCode) {
            showToast("バーコードを読み取ってください", "error");
            return;
        }

        if (POWER_AUTOMATE_URL === "YOUR_POWER_AUTOMATE_URL_HERE") {
            showToast("URLが設定されていません", "error");
            return;
        }

        // UIをロード中に変更
        btn.disabled = true;
        spinner.style.display = "inline-block";
        btnText.innerText = "送信中...";

        const data = {
            code: currentCode,
            count: qty
        };

        // Fetch APIで送信
        fetch(POWER_AUTOMATE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                showToast("登録しました！", "success");
                resetForm();
            } else {
                throw new Error("Server Error");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast("送信に失敗しました", "error");
        })
        .finally(() => {
            // UIを元に戻す
            btn.disabled = false;
            spinner.style.display = "none";
            btnText.innerText = "登録する";
        });
    }

    function resetForm() {
        currentCode = null;
        document.getElementById('code-display').innerText = "未スキャン";
        document.getElementById('code-display').classList.add('placeholder-text');
        document.getElementById('qty-input').value = 1;
    }

    // トースト通知を表示
    function showToast(message, type) {
        const toast = document.getElementById("toast");
        toast.className = "show " + type;
        toast.innerText = message;
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }
    
    // 初期表示設定
    document.getElementById('camera-placeholder').style.display = 'block';

</script>
</body>
</html>
